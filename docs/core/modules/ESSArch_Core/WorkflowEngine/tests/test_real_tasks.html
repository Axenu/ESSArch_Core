<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ESSArch_Core.WorkflowEngine.tests.test_real_tasks &#8212; ESSArch Core 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../../static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ESSArch_Core.WorkflowEngine.tests.test_real_tasks</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">httpretty</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests_toolbelt.multipart</span> <span class="k">import</span> <span class="n">decoder</span>

<span class="kn">from</span> <span class="nn">celery</span> <span class="k">import</span> <span class="n">states</span> <span class="k">as</span> <span class="n">celery_states</span>

<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.core</span> <span class="k">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="k">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">ESSArch_Core.configuration.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">EventType</span><span class="p">,</span>
    <span class="n">Path</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">ESSArch_Core.ip.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">EventIP</span><span class="p">,</span>
    <span class="n">InformationPackage</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">ESSArch_Core.util</span> <span class="k">import</span> <span class="n">find_and_replace_in_file</span><span class="p">,</span> <span class="n">parse_content_range_header</span>

<span class="kn">from</span> <span class="nn">ESSArch_Core.WorkflowEngine.models</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">ProcessStep</span><span class="p">,</span>
    <span class="n">ProcessTask</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="setUpModule"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.setUpModule">[docs]</a><span class="k">def</span> <span class="nf">setUpModule</span><span class="p">():</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">CELERY_ALWAYS_EAGER</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">settings</span><span class="o">.</span><span class="n">CELERY_EAGER_PROPAGATES_EXCEPTIONS</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CalculateChecksumTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase">[docs]</a><span class="k">class</span> <span class="nc">CalculateChecksumTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="CalculateChecksumTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.CalculateChecksum&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;file1.txt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_file_with_content"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_file_with_content">[docs]</a>    <span class="k">def</span> <span class="nf">test_file_with_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_empty_file"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_empty_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_empty_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_small_block_size"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_small_block_size">[docs]</a>    <span class="k">def</span> <span class="nf">test_small_block_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;2c26b46b68ffc68ff99b453c1d30413413422d706483bfa0f98a5e886266e7ae&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_md5"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_md5">[docs]</a>    <span class="k">def</span> <span class="nf">test_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;MD5&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;acbd18db4cc2f85cedef654fccc4a4d8&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_sha1"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_sha1">[docs]</a>    <span class="k">def</span> <span class="nf">test_sha1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;SHA-1&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;0beec7b5ea3f0fdbc95d0dd47f3c5bc275da8a33&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_sha224"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_sha224">[docs]</a>    <span class="k">def</span> <span class="nf">test_sha224</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;SHA-224&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;0808f64e60d58979fcb676c96ec938270dea42445aeefcd3a4e6f8db&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_sha384"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_sha384">[docs]</a>    <span class="k">def</span> <span class="nf">test_sha384</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;SHA-384&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;98c11ffdfdd540676b1a137cb1a22b2a70350c9a44171d6b1180c6be5cbb2ee3f79d532c8a1dd9ef2e8e08e752a3babb&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="CalculateChecksumTestCase.test_sha512"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CalculateChecksumTestCase.test_sha512">[docs]</a>    <span class="k">def</span> <span class="nf">test_sha512</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;SHA-512&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;f7fbba6e0636f890e56fbbf3283e524c6fa3204ae298382d624741d0dc6638326e282c41be5e4254d8820772c5518a2c5a8c0c7f7eda19594a7eb539453e1ed7&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase">[docs]</a><span class="k">class</span> <span class="nc">IdentifyFileFormatTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="IdentifyFileFormatTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.IdentifyFileFormat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;file1.txt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.test_file_with_content"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.test_file_with_content">[docs]</a>    <span class="k">def</span> <span class="nf">test_file_with_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;Plain Text File&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.test_filename_with_non_english_characters"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.test_filename_with_non_english_characters">[docs]</a>    <span class="k">def</span> <span class="nf">test_filename_with_non_english_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">u&#39;åäö.txt&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;Plain Text File&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.test_empty_file_with_filename_with_non_english_characters"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.test_empty_file_with_filename_with_non_english_characters">[docs]</a>    <span class="k">def</span> <span class="nf">test_empty_file_with_filename_with_non_english_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">u&#39;åäö.txt&#39;</span><span class="p">)</span>

        <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;Plain Text File&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.test_non_existent_file_extension"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.test_non_existent_file_extension">[docs]</a>    <span class="k">def</span> <span class="nf">test_non_existent_file_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;foo.zxczxc&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div>

<div class="viewcode-block" id="IdentifyFileFormatTestCase.test_non_existent_file_extension_with_filename_with_non_english_characters"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.IdentifyFileFormatTestCase.test_non_existent_file_extension_with_filename_with_non_english_characters">[docs]</a>    <span class="k">def</span> <span class="nf">test_non_existent_file_extension_with_filename_with_non_english_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;åäö.zxczxc&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenerateXMLTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase">[docs]</a><span class="k">class</span> <span class="nc">GenerateXMLTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="GenerateXMLTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.GenerateXML&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;-attr&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;fooAttr&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-containsFiles&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;FName&#39;</span><span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specData</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="s1">&#39;foodata&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="s1">&#39;bardata&#39;</span>
        <span class="p">}</span>

        <span class="n">Path</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;path_mimetypes_definitionfile&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;mime.types&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="GenerateXMLTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateXMLTestCase.test_without_file"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.test_without_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_without_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">specData</span><span class="p">,</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fooAttr&#39;</span><span class="p">),</span> <span class="s1">&#39;foodata&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;bardata&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="n">root</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateXMLTestCase.test_with_file"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.test_with_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_with_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;example.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">specData</span><span class="p">,</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
                <span class="p">},</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fooAttr&#39;</span><span class="p">),</span> <span class="s1">&#39;foodata&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;bardata&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;baz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;example.txt&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GenerateXMLTestCase.test_undo"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.test_undo">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">specData</span><span class="p">,</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">task</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span></div>

<div class="viewcode-block" id="GenerateXMLTestCase.test_undo_multiple_created_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.GenerateXMLTestCase.test_undo_multiple_created_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo_multiple_created_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">extra_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test2.xml&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">specData</span><span class="p">,</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                    <span class="n">extra_file</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">extra_file</span><span class="p">))</span>

        <span class="n">task</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">extra_file</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="InsertXMLTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase">[docs]</a><span class="k">class</span> <span class="nc">InsertXMLTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="InsertXMLTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.InsertXML&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted_var&#39;</span><span class="p">}]</span>
        <span class="p">}</span>

        <span class="n">Path</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;path_mimetypes_definitionfile&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;mime.types&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;root&gt;</span>
<span class="s2">                &lt;foo&gt;&lt;nested&gt;&lt;duplicate&gt;&lt;/duplicate&gt;&lt;/nested&gt;&lt;/foo&gt;</span>
<span class="s2">                &lt;bar&gt;&lt;duplicate&gt;&lt;/duplicate&gt;&lt;/bar&gt;</span>
<span class="s2">            &lt;/root&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_insert_empty_to_root"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_insert_empty_to_root">[docs]</a>    <span class="k">def</span> <span class="nf">test_insert_empty_to_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_insert_non_empty_to_root"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_insert_non_empty_to_root">[docs]</a>    <span class="k">def</span> <span class="nf">test_insert_non_empty_to_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">inserted</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">inserted</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">inserted</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_insert_to_element_with_children"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_insert_to_element_with_children">[docs]</a>    <span class="k">def</span> <span class="nf">test_insert_to_element_with_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">foo</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//foo&#39;</span><span class="p">)</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//nested&#39;</span><span class="p">)</span>
        <span class="n">inserted</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nested</span><span class="p">),</span> <span class="n">foo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inserted</span><span class="p">))</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_insert_at_index"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_insert_at_index">[docs]</a>    <span class="k">def</span> <span class="nf">test_insert_at_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">},</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">foo</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//foo&#39;</span><span class="p">)</span>
        <span class="n">nested</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//nested&#39;</span><span class="p">)</span>
        <span class="n">inserted</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertLess</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">inserted</span><span class="p">),</span> <span class="n">foo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">nested</span><span class="p">))</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_insert_to_duplicate_element"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_insert_to_duplicate_element">[docs]</a>    <span class="k">def</span> <span class="nf">test_insert_to_duplicate_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;duplicate&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//duplicate&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">duplicates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">duplicates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_undo"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_undo">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted data&#39;</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">))</span>

        <span class="n">task</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="InsertXMLTestCase.test_undo_index"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.InsertXMLTestCase.test_undo_index">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task1</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted 1&#39;</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task2</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted 2&#39;</span><span class="p">},</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task3</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;elementToAppendTo&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">,</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;inserted_var&#39;</span><span class="p">:</span> <span class="s1">&#39;inserted 3&#39;</span><span class="p">},</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task1</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">task2</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="n">task3</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 1&#39;</span><span class="p">)</span>

        <span class="n">task3</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 1&#39;</span><span class="p">)</span>

        <span class="n">task2</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;inserted 1&#39;</span><span class="p">)</span>

        <span class="n">task1</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//inserted&#39;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="AppendEventsTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.AppendEventsTestCase">[docs]</a><span class="k">class</span> <span class="nc">AppendEventsTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="AppendEventsTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.AppendEventsTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.AppendEvents&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">InformationPackage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Label</span><span class="o">=</span><span class="s2">&quot;testip&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;premis:premis xmlns:premis=&#39;http://xml.ra.se/PREMIS&#39;</span>
<span class="s2">            xmlns:xsi=&#39;http://www.w3.org/2001/XMLSchema-instance&#39;</span>
<span class="s2">            xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39;</span>
<span class="s2">            xsi:schemaLocation=&#39;http://xml.ra.se/PREMIS http://xml.ra.se/PREMIS/ESS/RA_PREMIS_PreVersion.xsd&#39;</span>
<span class="s2">            version=&#39;2.0&#39;&gt;</span>
<span class="s2">            &lt;/premis:premis&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="AppendEventsTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.AppendEventsTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="AppendEventsTestCase.test_undo"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.AppendEventsTestCase.test_undo">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">event_type</span> <span class="o">=</span> <span class="n">EventType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">EventIP</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">eventType</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span> <span class="n">linkingAgentIdentifierValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">linkingObjectIdentifierValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="p">),</span>

        <span class="n">task1</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">EventIP</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="n">information_package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
        <span class="p">)</span>

        <span class="n">task1</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">EventIP</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">EventIP</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">eventType</span><span class="o">=</span><span class="n">event_type</span><span class="p">,</span> <span class="n">linkingAgentIdentifierValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                <span class="n">linkingObjectIdentifierValue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="p">),</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//{*}event&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">task2</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="n">EventIP</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">},</span>
            <span class="n">information_package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
        <span class="p">)</span>

        <span class="n">task2</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//{*}event&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">task2</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//{*}event&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>

        <span class="n">task1</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//{*}event&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ValidateFilesTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateFilesTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ValidateFilesTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.ValidateFiles&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">InformationPackage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Label</span><span class="o">=</span><span class="s2">&quot;testip&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>

        <span class="n">Path</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;path_mimetypes_definitionfile&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;mime.types&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-containsFiles&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;-filters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;FName&#39;</span><span class="p">:</span> <span class="s1">&#39;^((?!&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;).)*$&#39;</span><span class="p">},</span>
                    <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;contentLocation&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;contentLocationValue&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;file:///&#39;</span><span class="p">,</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;href&#39;</span>
                                        <span class="p">}</span>
                                    <span class="p">]</span>
                                <span class="p">}]</span>
                            <span class="p">}]</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;objectCharacteristics&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;fixity&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;messageDigest&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                                <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;FChecksum&#39;</span>
                                            <span class="p">}]</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;messageDigestAlgorithm&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                                <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;FChecksumType&#39;</span>
                                            <span class="p">}]</span>
                                        <span class="p">}</span>
                                    <span class="p">]</span>
                                <span class="p">},</span>
                                <span class="p">{</span>
                                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;formatDesignation&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                                                <span class="p">{</span>
                                                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;formatName&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[</span>
                                                        <span class="p">{</span>
                                                            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;FFormatName&#39;</span>
                                                        <span class="p">}</span>
                                                    <span class="p">]</span>
                                                <span class="p">}</span>
                                            <span class="p">]</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;messageDigestAlgorithm&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                                <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;FChecksumType&#39;</span>
                                            <span class="p">}]</span>
                                        <span class="p">}</span>
                                    <span class="p">]</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s1">&#39;&lt;root&gt;&lt;/root&gt;&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_no_validation"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_no_validation">[docs]</a>    <span class="k">def</span> <span class="nf">test_no_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;validate_fileformat&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;validate_integrity&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_validation_without_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_validation_without_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_without_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_validation_with_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_validation_with_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;rootdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_of_files</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_change_checksum"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_change_checksum">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;rootdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> updated&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s1">&#39;checksum&#39;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_change_file_format"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_change_file_format">[docs]</a>    <span class="k">def</span> <span class="nf">test_change_file_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;rootdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.pdf&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

        <span class="n">find_and_replace_in_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s1">&#39;fileformat&#39;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateFilesTestCase.test_fail_and_stop_step_when_inner_task_fails"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFilesTestCase.test_fail_and_stop_step_when_inner_task_fails">[docs]</a>    <span class="k">def</span> <span class="nf">test_fail_and_stop_step_when_inner_task_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.txt&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;rootdir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run_eagerly</span><span class="p">()</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">ProcessStep</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Validate Files&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">celery_states</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">celery_states</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ValidateIntegrityTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateIntegrityTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateIntegrityTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ValidateIntegrityTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateIntegrityTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.ValidateIntegrity&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.txt&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="ValidateIntegrityTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateIntegrityTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateIntegrityTestCase.test_correct"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateIntegrityTestCase.test_correct">[docs]</a>    <span class="k">def</span> <span class="nf">test_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.CalculateChecksum&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">checksum</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateIntegrityTestCase.test_incorrect"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateIntegrityTestCase.test_incorrect">[docs]</a>    <span class="k">def</span> <span class="nf">test_incorrect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.CalculateChecksum&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">checksum</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="n">checksum</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s1">&#39;checksum&#39;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ValidateFileFormatTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFileFormatTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateFileFormatTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ValidateFileFormatTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFileFormatTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.ValidateFileFormat&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.txt&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="ValidateFileFormatTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFileFormatTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateFileFormatTestCase.test_correct"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFileFormatTestCase.test_correct">[docs]</a>    <span class="k">def</span> <span class="nf">test_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.IdentifyFileFormat&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">fformat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;fileformat&#39;</span><span class="p">:</span> <span class="n">fformat</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateFileFormatTestCase.test_incorrect"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateFileFormatTestCase.test_incorrect">[docs]</a>    <span class="k">def</span> <span class="nf">test_incorrect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.IdentifyFileFormat&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">fformat</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">newfile</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">newfile</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">newfile</span><span class="p">,</span>
                <span class="s1">&#39;fileformat&#39;</span><span class="p">:</span> <span class="n">fformat</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ValidateXMLFileTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateXMLFileTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateXMLFileTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ValidateXMLFileTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateXMLFileTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.ValidateXMLFile&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xsd&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">schema_root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;xsd:schema xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;&gt;</span>
<span class="s2">                &lt;xsd:element name=&quot;foo&quot; type=&quot;xsd:integer&quot;/&gt;</span>
<span class="s2">            &lt;/xsd:schema&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">schema_root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ValidateXMLFileTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateXMLFileTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateXMLFileTestCase.test_correct"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateXMLFileTestCase.test_correct">[docs]</a>    <span class="k">def</span> <span class="nf">test_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s1">&#39;&lt;foo&gt;5&lt;/foo&gt;&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;xml_filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;schema_filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateXMLFileTestCase.test_incorrect"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateXMLFileTestCase.test_incorrect">[docs]</a>    <span class="k">def</span> <span class="nf">test_incorrect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s1">&#39;&lt;foo&gt;bar&lt;/foo&gt;&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;xml_filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
                <span class="s1">&#39;schema_filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">DocumentInvalid</span><span class="p">,</span> <span class="s1">&#39;not a valid value of the atomic type&#39;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase">[docs]</a><span class="k">class</span> <span class="nc">ValidateLogicalPhysicalRepresentationTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.ValidateLogicalPhysicalRepresentation&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test1.xml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">InformationPackage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Label</span><span class="o">=</span><span class="s2">&quot;testip&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;testuser&quot;</span><span class="p">)</span>

        <span class="n">Path</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">entity</span><span class="o">=</span><span class="s2">&quot;path_mimetypes_definitionfile&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;mime.types&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;-containsFiles&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;-filters&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;FName&#39;</span><span class="p">:</span> <span class="s1">&#39;^((?!&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;).)*$&#39;</span><span class="p">},</span>
                    <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;storage&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;contentLocation&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;-children&#39;</span><span class="p">:</span> <span class="p">[{</span>
                                    <span class="s1">&#39;-name&#39;</span><span class="p">:</span> <span class="s1">&#39;contentLocationValue&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;#content&#39;</span><span class="p">:</span> <span class="p">[</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;file:///&#39;</span><span class="p">,</span>
                                        <span class="p">},</span>
                                        <span class="p">{</span>
                                            <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;href&#39;</span>
                                        <span class="p">}</span>
                                    <span class="p">]</span>
                                <span class="p">}]</span>
                            <span class="p">}]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}]</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="s1">&#39;&lt;root&gt;&lt;/root&gt;&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_without_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_without_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_without_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
                <span class="s1">&#39;files_reldir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_incorrect_file_name"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_incorrect_file_name">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_incorrect_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;txtx&#39;</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
                <span class="s1">&#39;files_reldir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s2">&quot;the logical representation differs from the physical&quot;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_too_many_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_too_many_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_too_many_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_of_files</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
                <span class="s1">&#39;files_reldir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s2">&quot;the logical representation differs from the physical&quot;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_too_few_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_too_few_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_too_few_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_of_files</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
                <span class="s1">&#39;files_reldir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s2">&quot;the logical representation differs from the physical&quot;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_file_in_wrong_folder"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.ValidateLogicalPhysicalRepresentationTestCase.test_validation_with_file_in_wrong_folder">[docs]</a>    <span class="k">def</span> <span class="nf">test_validation_with_file_in_wrong_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_of_files</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_of_files</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ESSArch_Core.tasks.GenerateXML&#39;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;filesToCreate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filesToCreate</span><span class="p">,</span>
                <span class="s1">&#39;folderToParse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">moved_file</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;new_dir&#39;</span><span class="p">)</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">moved_file</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">new_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">moved_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>

        <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_file</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
                <span class="s1">&#39;files_reldir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
                <span class="s1">&#39;xmlfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span> <span class="s2">&quot;the logical representation differs from the physical&quot;</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="UpdateIPStatusTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPStatusTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdateIPStatusTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateIPStatusTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPStatusTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.UpdateIPStatus&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">InformationPackage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Label</span><span class="o">=</span><span class="s2">&quot;testip&quot;</span><span class="p">,</span> <span class="n">State</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateIPStatusTestCase.test_update"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPStatusTestCase.test_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateIPStatusTestCase.test_undo"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPStatusTestCase.test_undo">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">State</span><span class="p">,</span> <span class="s1">&#39;initial&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateIPPathTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPPathTestCase">[docs]</a><span class="k">class</span> <span class="nc">UpdateIPPathTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="UpdateIPPathTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPPathTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.UpdateIPPath&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">InformationPackage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">Label</span><span class="o">=</span><span class="s2">&quot;testip&quot;</span><span class="p">,</span> <span class="n">ObjectPath</span><span class="o">=</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateIPPathTestCase.test_update"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPPathTestCase.test_update">[docs]</a>    <span class="k">def</span> <span class="nf">test_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">ObjectPath</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="UpdateIPPathTestCase.test_undo"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.UpdateIPPathTestCase.test_undo">[docs]</a>    <span class="k">def</span> <span class="nf">test_undo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;new&#39;</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">ObjectPath</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">undo</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">ObjectPath</span><span class="p">,</span> <span class="s1">&#39;initial&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DeleteFilesTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase">[docs]</a><span class="k">class</span> <span class="nc">DeleteFilesTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="DeleteFilesTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.DeleteFiles&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="DeleteFilesTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="DeleteFilesTestCase.test_delete_empty_dir"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase.test_delete_empty_dir">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_empty_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;newdir&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">dirname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">))</span></div>

<div class="viewcode-block" id="DeleteFilesTestCase.test_delete_dir_with_files"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase.test_delete_dir_with_files">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_dir_with_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;newdir&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">dirname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">))</span></div>

<div class="viewcode-block" id="DeleteFilesTestCase.test_delete_file"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.DeleteFilesTestCase.test_delete_file">[docs]</a>    <span class="k">def</span> <span class="nf">test_delete_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;test.txt&#39;</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">fname</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="CopyFileTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase">[docs]</a><span class="k">class</span> <span class="nc">CopyFileTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="CopyFileTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s2">&quot;ESSArch_Core.tasks.CopyFile&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;src.txt&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span></div>

<div class="viewcode-block" id="CopyFileTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="CopyFileTestCase.test_local_empty"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_local_empty">[docs]</a>    <span class="k">def</span> <span class="nf">test_local_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dst.txt&quot;</span><span class="p">)</span>

        <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span></div>

<div class="viewcode-block" id="CopyFileTestCase.test_local_non_empty"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_local_non_empty">[docs]</a>    <span class="k">def</span> <span class="nf">test_local_non_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dst.txt&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="CopyFileTestCase.test_local_small_block_size"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_local_small_block_size">[docs]</a>    <span class="k">def</span> <span class="nf">test_local_small_block_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dst.txt&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                <span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="CopyFileTestCase.test_local_dst_existing"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_local_dst_existing">[docs]</a>    <span class="k">def</span> <span class="nf">test_local_dst_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dst.txt&quot;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
        <span class="n">dstcontent</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dstcontent</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

    <span class="nd">@httpretty</span><span class="o">.</span><span class="n">activate</span>
<div class="viewcode-block" id="CopyFileTestCase.test_remote"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_remote">[docs]</a>    <span class="k">def</span> <span class="nf">test_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;src.txt&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;http://remote.destination/upload&quot;</span>
        <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dstdir&quot;</span><span class="p">)</span>
        <span class="n">dst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="n">multipart_data</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">MultipartDecoder</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">multipart_data</span><span class="o">.</span><span class="n">parts</span>

            <span class="n">chunk</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="n">content_range</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_content_range_header</span><span class="p">(</span><span class="n">content_range</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

        <span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">request_callback</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                <span class="s1">&#39;requests_session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

    <span class="nd">@httpretty</span><span class="o">.</span><span class="n">activate</span>
<div class="viewcode-block" id="CopyFileTestCase.test_remote_small_block_size"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_remote_small_block_size">[docs]</a>    <span class="k">def</span> <span class="nf">test_remote_small_block_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;src.txt&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;http://remote.destination/upload&quot;</span>
        <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dstdir&quot;</span><span class="p">)</span>
        <span class="n">dst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="n">multipart_data</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">MultipartDecoder</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">multipart_data</span><span class="o">.</span><span class="n">parts</span>

            <span class="n">chunk</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="n">content_range</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_content_range_header</span><span class="p">(</span><span class="n">content_range</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

        <span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">request_callback</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                <span class="s1">&#39;requests_session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
                <span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

    <span class="nd">@httpretty</span><span class="o">.</span><span class="n">activate</span>
<div class="viewcode-block" id="CopyFileTestCase.test_failing_remote"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_failing_remote">[docs]</a>    <span class="k">def</span> <span class="nf">test_failing_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;src.txt&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;http://remote.destination/upload&quot;</span>
        <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dstdir&quot;</span><span class="p">)</span>
        <span class="n">dst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">incorrect_request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="n">multipart_data</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">MultipartDecoder</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">multipart_data</span><span class="o">.</span><span class="n">parts</span>

            <span class="n">chunk</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="n">content_range</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_content_range_header</span><span class="p">(</span><span class="n">content_range</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

        <span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">incorrect_request_callback</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                <span class="s1">&#39;requests_session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
                <span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div>

    <span class="nd">@httpretty</span><span class="o">.</span><span class="n">activate</span>
<div class="viewcode-block" id="CopyFileTestCase.test_retry_remote"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.CopyFileTestCase.test_retry_remote">[docs]</a>    <span class="k">def</span> <span class="nf">test_retry_remote</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;src.txt&quot;</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;http://remote.destination/upload&quot;</span>
        <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;dstdir&quot;</span><span class="p">)</span>
        <span class="n">dst_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">fail</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">def</span> <span class="nf">incorrect_request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
            <span class="n">multipart_data</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">MultipartDecoder</span><span class="o">.</span><span class="n">from_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">multipart_data</span><span class="o">.</span><span class="n">parts</span>

            <span class="n">chunk</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

            <span class="n">content_range</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s1">&#39;Content-Range&#39;</span><span class="p">)</span>
            <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span> <span class="o">=</span> <span class="n">parse_content_range_header</span><span class="p">(</span><span class="n">content_range</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dstf</span><span class="p">:</span>
                    <span class="n">dstf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                    <span class="k">global</span> <span class="n">fail</span>
                    <span class="k">if</span> <span class="n">fail</span><span class="p">:</span>
                        <span class="n">fail</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">return</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

                    <span class="n">dstf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;The </span><span class="si">{}</span><span class="s2"> response from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

        <span class="n">httpretty</span><span class="o">.</span><span class="n">register_uri</span><span class="p">(</span><span class="n">httpretty</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">incorrect_request_callback</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;src&#39;</span><span class="p">:</span> <span class="n">src</span><span class="p">,</span>
                <span class="s1">&#39;dst&#39;</span><span class="p">:</span> <span class="n">dst</span><span class="p">,</span>
                <span class="s1">&#39;requests_session&#39;</span><span class="p">:</span> <span class="n">session</span><span class="p">,</span>
                <span class="s1">&#39;block_size&#39;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">ProcessStep</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name__startswith</span><span class="o">=</span><span class="s2">&quot;Copy&quot;</span><span class="p">)</span>

        <span class="n">step</span><span class="o">.</span><span class="n">undo</span><span class="p">(</span><span class="n">only_failed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">retry</span><span class="p">()</span>
        <span class="n">step</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst_file</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">dst_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">content</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SendEmailTestCase"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.SendEmailTestCase">[docs]</a><span class="k">class</span> <span class="nc">SendEmailTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="SendEmailTestCase.setUp"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.SendEmailTestCase.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="s1">&#39;ESSArch_Core.tasks.SendEmail&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sender</span> <span class="o">=</span> <span class="s1">&#39;from@example.com&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recipients</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;to1@example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;to2@example2.com&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;this is the subject&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;this is the body&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datadir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;datadir&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">17</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span> <span class="s2">&quot;file1.txt&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SendEmailTestCase.tearDown"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.SendEmailTestCase.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span></div>

<div class="viewcode-block" id="SendEmailTestCase.test_send"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.SendEmailTestCase.test_send">[docs]</a>    <span class="k">def</span> <span class="nf">test_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sender&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                <span class="s1">&#39;recipients&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipients</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span>
                <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span></div>

<div class="viewcode-block" id="SendEmailTestCase.test_send_attachments"><a class="viewcode-back" href="../../../../ESSArch_Core.WorkflowEngine.tests.html#ESSArch_Core.WorkflowEngine.tests.test_real_tasks.SendEmailTestCase.test_send_attachments">[docs]</a>    <span class="k">def</span> <span class="nf">test_send_attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>

        <span class="n">attachments</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">]</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">ProcessTask</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">taskname</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;sender&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sender</span><span class="p">,</span>
                <span class="s1">&#39;recipients&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">recipients</span><span class="p">,</span>
                <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span>
                <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                <span class="s1">&#39;attachments&#39;</span><span class="p">:</span> <span class="n">attachments</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">task</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attachments</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, ES Solutions.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>